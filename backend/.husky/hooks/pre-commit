#!/usr/bin/env bash

set -u

cp ./backend/husky/hooks/* .git/hooks/

# # ä»ä¸­è¿‡æ»¤å‡ºæœªä¿®æ”¹è¿‡çš„æ–‡ä»¶å¤¹ï¼Œ
# arr=$(git status -s | awk '{print $2}' | grep -o -E '^(ego-api|ego-teach|ego-oj|ego-user|ego-device|ego-job)' | uniq)

# è„šæœ¬è¿è¡Œçš„å¼€å§‹æ—¶é—´
start=$(date +%s%N)

function p() {
    printf "\r\033[K%s" "$1"
}

# if go test failed, exit
# if ! output="$(go test -timeout 30s -run ^TestRoutes$ ego-api)"; then
#     echo "$output"
#     echo "    API æ³¨å†Œå¤±è´¥, è¯·æ£€æŸ¥ä¸Šè¿°æœåŠ¡æˆ– Middleware çš„å‡½æ•°å‚æ•°ï¼Œè¿”å›å€¼ï¼"
#     exit 1
# fi

# for proj in $arr; do
# echo "æ­£åœ¨æ£€æŸ¥ $proj ..."

# cd "$proj" || exit 1
p "å½“å‰è·¯å¾„: $(pwd)"
p "Step-1 æ­£åœ¨æ£€æŸ¥ä¾èµ–..."
output="$(cd ./backend && go mod tidy -v 2>&1)"
if [ -n "$output" ]; then
    echo "Step-1 (go mod tidy) éœ€è¦æ›´æ–° go.mod å’Œ go.sum"
    echo "    go.mod å’Œ go.sum å·²è¢«ä¿®æ”¹ï¼Œè¯·é‡æ–°ä½¿ç”¨ git add æ·»åŠ ç›¸å…³æ–‡ä»¶ï¼"
    exit 1
fi
p "å½“å‰è·¯å¾„: $(pwd)"
p "Step-2 æ­£åœ¨æ£€æŸ¥è¯­æ³•..."
output="$(go vet ./... 2>&1)"
if [ -n "$output" ]; then
    echo "Step-2 (go vet) å¤±è´¥:"
    echo "    $output"
    exit 1
fi

p "Step-3 æ­£åœ¨æ£€æŸ¥ä»£ç æ ¼å¼åŒ–..."
output="$(gofmt -l -w . 2>&1)"
if [ -n "$output" ]; then
    echo "Step-3 (gofmt) å¤±è´¥ï¼Œä¸‹åˆ—æ–‡ä»¶å·²è¢«æ ¼å¼åŒ–:"
    echo "    - $output"
    echo "ä¸Šè¿°æ–‡ä»¶å·²è¢«æ ¼å¼åŒ–, è¯·ä½¿ç”¨ git add é‡æ–°æ·»åŠ ç›¸å…³æ–‡ä»¶ï¼"
    exit 1
fi

# p "Step-4 æ­£åœ¨å°è¯•ç¼–è¯‘æ£€æŸ¥..."
# if ! output="$(go build -v . 2>&1)"; then
#     p "Step-4 (go build) ç¼–è¯‘å¤±è´¥:"
#     p "    - $proj/$output"
#     exit 1
# fi

# p "Step-5 æ­£åœ¨è¿è¡Œæµ‹è¯•..."
# if ! output="$(go test -tags=unit -timeout 30s -short -v ./... 2>&1)"; then
#     echo "Step-5 æµ‹è¯•è¿è¡Œå¤±è´¥, è¯·æ£€æŸ¥!"
#     echo "$output"
#     exit 1
# fi

p ""
cd ..
# done

end=$(date +%s%N)

# è®¡ç®—æ—¶é—´å·®ï¼Œå•ä½ä¸ºç§’
det=$((("$end" - "$start") / 1000000000))
p "ğŸ‰ å…¨éƒ¨æ£€æŸ¥é€šè¿‡, æ€»è€—æ—¶: $det ç§’"
